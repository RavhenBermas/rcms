{% extends "base.html" %}
{% load static %}
{% block content %}

<h1 class="text-xl sm:text-2xl md:text-3xl font-bold mb-6">Daily Scanned Charts</h1>

<div class="bg-white pt-4 pb-10">
    <div class="w-full px-3 mx-auto">

        <!-- ADD CHART BUTTON + SEARCH -->
        <div class="w-full mb-4 flex flex-col sm:flex-row justify-between items-end gap-2">
            <!-- Add Chart Button -->
            <button onclick="openModal()"
                class="bg-blue-600 cursor-pointer text-white px-4 py-2 rounded hover:bg-blue-700">
                + Add Daily Chart
            </button>

            <!-- Search Input -->
            <div class="relative w-full sm:w-64">
                <input type="text" id="searchInput" placeholder="Search..." autocomplete="off"
                    class="w-full pl-4 pr-10 py-2 border rounded focus:outline-none focus:ring-1">
                <i
                    class='bx bx-search cursor-pointer z-10 text-gray-500 text-lg absolute right-3 top-1/2 -translate-y-1/2'></i>
            </div>
        </div>

        <!-- TABLE -->
        <div class="w-full overflow-x-auto rounded">
            <table id="productTable" class="min-w-300 w-full text-left border border-gray-300">
                <thead class="bg-blue-400 text-gray-100">
                    <tr>
                        <th class="py-3 px-3 font-bold">ID</th>
                        <th class="py-3 px-3 font-bold">Station Name</th>
                        <th class="py-3 px-3 font-bold">Station Code</th>
                        <th class="py-3 px-3 font-bold">Station ID</th>
                        <th class="py-3 px-3 font-bold">Date</th>
                        <th class="py-3 px-3 font-bold">Assignment</th>
                        <th class="py-3 px-3 font-bold">Date Uploaded</th>
                        <th class="py-3 px-3 font-bold">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y">
                    <!-- Rows load here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination & showing text -->
        <div class="w-full flex justify-between flex-col sm:flex-row gap-5 mt-4 px-1 items-center">
            <div id="showingText" class="text-lg">No entries to show</div>
            <ul id="pagination" class="flex justify-center items-center gap-x-2"></ul>
        </div>

    </div>
</div>

<!--VIEW MODAL -->
<div id="view" class="fixed inset-0 bg-opacity-50 hidden flex justify-center items-center">

    <div class="bg-white w-125 p-6 rounded shadow-lg">

        <div class="flex justify-between mb-4">
            <button onclick="closeViewModal()" class="text-red-500 text-xl">✖</button>
        </div>
    </div>
</div>
<!--END OF VIEW MODAL -->

<!--ADD CHARTS MODAL -->
<div id="modal" class="fixed inset-0 bg-opacity-50 hidden justify-center flex items-center">

    <div class="bg-white w-125 p-6 rounded shadow-lg">

        <div class="flex justify-between mb-4">
            <h2 class="text-xl font-bold">Add Daily Chart</h2>
            <button onclick="closeModal()" class="text-red-500 text-xl">✖</button>
        </div>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Make grid responsive: 1 col on small, 2 col on sm+ -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">

                <div>
                    <label>Station Name</label>
                    <input type="text" name="station_name" required class="w-full border p-2 rounded">
                </div>

                <div>
                    <label>Station ID</label>
                    <input type="text" name="station_id" required class="w-full border p-2 rounded">
                </div>

                <div>
                    <label>Station Code</label>
                    <input type="text" name="station_code" required class="w-full border p-2 rounded">
                </div>

                <div>
                    <label>Assignment</label>
                    <input type="text" name="assignment" required class="w-full border p-2 rounded">
                </div>

                <div>
                    <label>Upload Image</label>
                    <input type="file" accept="image" name="imageFile" required class="w-full border p-2 rounded">
                </div>

                <div>
                    <label>Date</label>
                    <input type="date" name="date" required class="w-full border p-2 rounded">
                </div>

            </div>

            <div class="mt-4 flex justify-end gap-2">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 cursor-pointer bg-gray-400 rounded text-white">
                    Cancel
                </button>

                <button type="submit" class="px-4 py-2 cursor-pointer bg-blue-600 rounded text-white hover:bg-blue-700">
                    Save
                </button>
            </div>

        </form>
    </div>
</div>
<!--END OF ADD CHARTS MODAL -->

<!-- VIEW IMAGE MODAL -->
<div id="viewImageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="relative bg-white rounded shadow-lg max-w-lg w-full p-4">
        <button onclick="closeImageModal()"
            class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
        <img id="modalImage" src="" alt="Chart Image" class="w-full h-auto rounded">
    </div>
</div>


<script>
    function openImageModal(imageUrl) {
        const modal = document.getElementById("viewImageModal");
        const img = document.getElementById("modalImage");
        img.src = imageUrl;       // Set the image URL dynamically
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeImageModal() {
        const modal = document.getElementById("viewImageModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }
    function openModal() {
        document.getElementById("modal").classList.remove("hidden");
        document.getElementById("modal").classList.add("flex");
    }

    function closeModal() {
        document.getElementById("modal").classList.add("hidden");
    }

    const rowsLimit = 5;
    let currentPage = 0;

    const charts = JSON.parse('{{ charts_json| escapejs}}');

    function renderTable() {
        const start = currentPage * rowsLimit;
        const end = start + rowsLimit;
        const rows = charts.slice(start, end);

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (rows.length === 0) {
            tbody.innerHTML = `
                                <tr>
                                    <td colspan="8" class="text-center border-b py-4 text-gray-500">
                                        No data available
                                    </td>
                                </tr>`;
            document.getElementById("showingText").innerText = "No entries to show";
            document.getElementById("pagination").innerHTML = "";
            return;
        }

        rows.forEach((c, i) => {
            tbody.innerHTML += `
                                <tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-100'} border-b border-gray-300">
                                    <td class="py-2 px-3">${c.id}</td>
                                    <td class="py-2 px-3">${c.station_name}</td>
                                    <td class="py-2 px-3">${c.station_code}</td>
                                    <td class="py-2 px-3">${c.station_id}</td>
                                    <td class="py-2 px-3">${c.date}</td>
                                    <td class="py-2 px-3">${c.assignment}</td>
                                    <td class="py-2 px-3">${c.uploaded_at}</td>
                                    <td class="py-2 px-3">
                                        <div>
                                            <a href="/view-charts/${c.id}/" class="bg-green-500 py-1 px-2 rounded text-white"><i class='bx bx-show'></i></a>
                                            {% if user.is_staff or user.is_superuser %}
                                            <a href="#" class="bg-amber-500 py-1 px-2 rounded text-white"><i class='bx bx-edit'></i></a>
                                            {% endif %}
                                            {% if user.is_superuser %}
                                            <a href="#" class="bg-red-500 py-1 px-2 rounded text-white"><i class='bx bx-trash'></i></a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>`;
        });

        document.getElementById("showingText").innerText =
            `Showing ${start + 1} to ${Math.min(end, charts.length)} of ${charts.length} entries`;

        renderPagination();
    }

    function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPage = Math.ceil(charts.length / rowsLimit);

        if (charts.length === 0) return;

        pagination.innerHTML += `
                                <li onclick="prevPage()" class="w-8 h-8 border rounded flex justify-center items-center cursor-pointer 
                                        ${currentPage === 0 ? 'bg-gray-300 pointer-events-none' : ''}">
                                    ‹
                                </li>`;

        for (let i = 0; i < totalPage; i++) {
            pagination.innerHTML += `   <li onclick="goPage(${i})" class="w-8 h-8 border rounded flex justify-center items-center cursor-pointer
                                            ${currentPage === i ? 'border-blue-500 text-blue-500 font-bold' : ''}">
                                            ${i + 1}
                                        </li>`;
        }

        pagination.innerHTML += `
                                <li onclick="nextPage()" class="w-8 h-8 border rounded flex justify-center items-center cursor-pointer 
                                    ${currentPage === totalPage - 1 ? 'bg-gray-300 pointer-events-none' : ''}">
                                    ›
                                </li>`;
    }

    function nextPage() {
        const totalPage = Math.ceil(charts.length / rowsLimit);
        if (currentPage < totalPage - 1) currentPage++; renderTable();
    } function prevPage() {
        if (currentPage > 0)
            currentPage--;
        renderTable();
    }

    function goPage(i) {
        currentPage = i;
        renderTable();
    }

    renderTable();
</script>


{% endblock %}